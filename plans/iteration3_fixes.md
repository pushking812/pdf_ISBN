# План исправления ошибок - Итерация 3

## Контекст
Согласно TODO.md, Итерация 3 включает улучшения качества и UX:
1. Унифицировать критерии уникальности классов; расширить генерацию по всем фрагментам
2. Параметризовать выбор атрибутов (text/href/src) и описать в докстрингах/CONCEPTION.md
3. Перейти на стандартный CLI для parse_arguments (с учетом сохранения удобства настройки)

## Уточнение архитектурного контекста
- Модуль `debug_selectors.py` будет использоваться в основном в `scraper.py`
- `debug_selectors.py` останется как точка доступа с функционалом для тестирования
- Основной точкой входа будет `main.py`
- Важно сохранить возможность видеть и быстро изменять параметры запуска в точке входа

## Детальный план

### Задача 1: Унификация критериев уникальности классов и расширение генерации паттернов

**Проблемы:**
1. Несогласованность критериев уникальности: `collect_unique_classes` проверяет уникальность внутри `ancestor`, а `get_css_selector` - внутри всего `soup`
2. Используется только `fragments[0]`, остальные фрагменты игнорируются

**Решение:**
1. Унифицировать критерий проверки уникальности классов внутри `ancestor` (более строгий подход)
2. Модифицировать `generate_pattern` для обработки всех фрагментов и генерации альтернативных паттернов

**Подзадачи:**
1.1. Анализ текущей логики уникальности классов в `collect_unique_classes` и `get_css_selector`
1.2. Рефакторинг `get_css_selector` с добавлением параметра `ancestor`
1.3. Изменение проверки уникальности: `len(soup.select(...))` → `len(ancestor.select(...))`
1.4. Модификация цикла в `generate_pattern` для итерации по всем элементам `fragments`
1.5. Создание механизма приоритизации паттернов (по наличию id, уникальности класса, специфичности)
1.6. Тестирование на существующих тестовых данных
1.7. Обновление документации в докстрингах

**Оценка времени:** ~9 часов

### Задача 2: Параметризация выбора атрибутов

**Проблемы:**
1. Жестко закодированная эвристика выбора атрибута для `<a>` элементов (text vs href)
2. Невозможность указать предпочтительный атрибут через конфигурацию

**Решение:**
1. Добавить параметр `--attribute` в CLI с поддержкой значений: `auto`, `text`, `href`, `src`, `content`
2. Модифицировать логику выбора атрибута с сохранением эвристики для значения `auto`

**Подзадачи:**
2.1. Добавление аргумента `--attribute` в `parse_arguments` с choices и значением по умолчанию `auto`
2.2. Модификация логики выбора атрибута в `generate_pattern` (строки 477-490)
2.3. Реализация fallback на `text` при отсутствии указанного атрибута
2.4. Обновление документации в докстрингах функции `generate_pattern`
2.5. Добавление раздела в CONCEPTION.md о стратегии выбора атрибутов
2.6. Тестирование с различными значениями `--attribute`

**Оценка времени:** ~6 часов

### Задача 3: Улучшение CLI с сохранением удобства настройки

**Проблемы:**
1. Нестандартный дизайн `parse_arguments` (принимает значения по умолчанию как параметры)
2. Необходимость сохранить видимость настроек в точке входа для быстрого изменения параметров

**Уточненное решение:**
1. Сохранить словарь настроек в `main` для быстрого изменения параметров тестирования
2. Рефакторить `parse_arguments` с поддержкой двух наборов defaults:
   - `normal_defaults`: для обычного режима CLI
   - `test_mode_defaults`: для режима с `--test` (видимый словарь в `main`)
3. Приоритеты применения значений: 1) аргументы CLI, 2) соответствующий словарь defaults, 3) hardcoded значения

**Подзадачи:**
3.1. Рефакторинг `parse_arguments` с новой сигнатурой:
   ```python
   def parse_arguments(
       defaults: Optional[Dict[str, Any]] = None,
       test_mode_defaults: Optional[Dict[str, Any]] = None,
   ) -> argparse.Namespace
   ```
3.2. Реализация логики выбора defaults в зависимости от флага `--test`
3.3. Обновление `main` с созданием двух словарей:
   - `test_mode_defaults`: видимый словарь для быстрой настройки тестов
   - `normal_defaults`: значения по умолчанию для обычного режима
3.4. Обеспечение обратной совместимости для вызовов из `scraper.py`
3.5. Тестирование CLI в обоих режимах (с `--test` и без)
3.6. Проверка работы с существующими тестами

**Оценка времени:** ~5 часов

## Дополнительные задачи

### 4. Обновление документации
- Обновление CONCEPTION.md с описанием изменений Итерации 3
- Добавление раздела о стратегии выбора атрибутов
- Обновление докстрингов в измененных функциях

### 5. Запись в PROGRESS.md
- Добавление записи о выполнении Итерации 3
- Указание исправленных проблем и добавленных улучшений

### 6. Проверка кода
- Запуск `ruff check .` для проверки стиля и ошибок
- Запуск `ruff format` для автоматического форматирования
- Проверка работы всех тестов

## Приоритет выполнения
1. **Задача 3** (улучшение CLI) - фундаментальное изменение, влияет на UX
2. **Задача 2** (параметризация атрибутов) - улучшает гибкость использования
3. **Задача 1** (унификация и расширение) - наиболее сложная, но критичная для качества генерации паттернов

## Ожидаемые результаты
После выполнения Итерации 3:
- Критерии уникальности классов будут унифицированы, что улучшит качество генерируемых CSS-селекторов
- Генерация паттернов будет учитывать все фрагменты, а не только первый
- Пользователь сможет указывать предпочтительный атрибут через командную строку
- CLI будет работать стандартным образом при сохранении удобства настройки тестовых параметров
- Настройки останутся видимыми в `main` для быстрого редактирования
- `scraper.py` сможет использовать функционал `debug_selectors.py` без проблем

## Риски и митигация
1. **Риск**: Унификация критериев уникальности может снизить количество генерируемых CSS-селекторов
   **Митигация**: Реализовать fallback на XPath, который более устойчив
2. **Риск**: Изменение CLI может нарушить существующие скрипты
   **Митигация**: Сохранить обратную совместимость через опциональные параметры
3. **Риск**: Обработка всех фрагментов может увеличить время выполнения
   **Митигация**: Добавить ограничение на максимальное количество обрабатываемых фрагментов

## Общая оценка времени
- Задача 1: ~9 часов
- Задача 2: ~6 часов
- Задача 3: ~5 часов
- Дополнительные задачи: ~2 часа
- **Итого:** ~22 часа

## Критерии успеха
- Все тесты проходят без ошибок
- CLI работает в обоих режимах (с `--test` и без)
- Генерация паттернов учитывает все фрагменты
- Выбор атрибута параметризуется через командную строку
- Настройки остаются видимыми в `main` для быстрого редактирования
- Документация обновлена (докстринги, CONCEPTION.md)