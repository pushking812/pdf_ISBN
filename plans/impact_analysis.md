# Анализ влияния изменений Итерации 1

## Обзор изменений
Планируемые изменения затрагивают следующие модули:
1. `debug_selectors.py` - функции `run_parse`, `run_search`, `extract_value`, `generate_pattern`, тестовые данные
2. `html_fragment.py` - функция `extract_common_parent_from_url`
3. Документация: `CONCEPTION.md`, `PROGRESS.md`

## Детальный анализ влияния

### 1. Исправление бага в run_parse

**Текущее состояние**: 
- В не-test режиме создается структура `{url: [(label, value)]}` (кортеж)
- Код ожидает словарь `pair['label']` → вызывает `TypeError`

**Предлагаемое изменение**:
- Изменить на `{url: [{'label': label, 'value': value}]}`
- Добавить проверку типа для обратной совместимости

**Влияние на код**:
- `run_parse` вызывается только из `main` в `debug_selectors.py` (строка 777)
- Внутренняя функция `search_web` ожидает строки `label` и `value`, что останется неизменным
- Тестовый режим уже использует словари, поэтому не пострадает
- **Риск**: Низкий. Изменение локализовано в одной функции.

**Необходимые дополнительные корректировки**:
- Обновить обработку в цикле `for pair in pairs` для поддержки обоих форматов
- Проверить, нет ли других мест, где ожидается кортеж (например, `print_fragments`)

### 2. Добавление timeout в extract_common_parent_from_url

**Текущее состояние**: 
- Нет параметра `timeout` в `requests.get`
- Возможны зависания

**Предлагаемое изменение**:
- Добавить параметр `timeout` со значением по умолчанию `None`
- Передать его в `requests.get`
- Обработать исключения `Timeout` и `RequestException`

**Влияние на код**:
- Функция вызывается из:
  - `debug_selectors.search_web` (строка 361)
  - Тестов `test_empty_label.py`
  - Прямых вызовов в других местах (если есть)
- Добавление нового параметра со значением по умолчанию **не сломает** существующие вызовы
- **Риск**: Низкий. Обратная совместимость сохранена.

**Необходимые дополнительные корректировки**:
- Обновить вызовы в `search_web` для передачи `timeout` (можно взять из `ScraperConfig`)
- Проверить тесты на корректную работу

### 3. Добавление timeout в run_search

**Текущее состояние**:
- Прямой `requests.get` без timeout и заголовков

**Предлагаемое изменение**:
- Добавить `timeout` и `headers` из `DEFAULT_HEADERS`
- Обработать исключения

**Влияние на код**:
- `run_search` вызывается только из `main` в `debug_selectors.py`
- Изменение внутренней логики не влияет на внешний интерфейс
- **Риск**: Низкий.

**Необходимые дополнительные корректировки**:
- Импортировать `DEFAULT_HEADERS` из `html_fragment`
- Импортировать `ScraperConfig` для значения timeout по умолчанию

### 4. Удаление "pass" в extract_value

**Текущее состояние**:
- В ветке XPath/lxml есть комментарий `pass` (строка 528)

**Предлагаемое изменение**:
- Удалить комментарий, явно описать поведение

**Влияние на код**:
- Косметическое изменение, не влияет на логику
- **Риск**: Нулевой.

### 5. Исправление аннотаций типов

**Текущее состояние**:
- Неверные аннотации в `get_test_data_to_parse`, `get_test_data_to_search`, `generate_pattern`

**Предлагаемое изменение**:
- Исправить аннотации на корректные типы

**Влияние на код**:
- Аннотации не влияют на выполнение кода
- Могут сломать проверки mypy, но это ожидаемо
- **Риск**: Низкий.

**Необходимые дополнительные корректировки**:
- Обновить аннотации во всех связанных функциях
- Проверить, что фактические типы соответствуют новым аннотациям

## Выводы

1. **Большинство изменений безопасны** и не требуют дополнительных корректировок в другом коде
2. **Критичное изменение** (формат пары в run_parse) требует осторожности, но локализовано в одном модуле
3. **Добавление новых параметров** со значениями по умолчанию сохраняет обратную совместимость
4. **Тесты могут потребовать обновления**, если они зависят от конкретных форматов данных или поведения при таймаутах

## Рекомендации

1. **Перед внесением изменений**:
   - Запустить существующие тесты для создания baseline
   - Создать backup критичных файлов

2. **После внесения изменений**:
   - Запустить `ruff check .` и `ruff format` для проверки стиля
   - Запустить тесты, особенно `test_empty_label.py` и `test_fix.py`
   - Проверить работу `debug_selectors.py` в test и non-test режимах

3. **Поэтапное внедрение**:
   - Сначала исправить критичный баг в run_parse
   - Затем добавить timeout в обе функции
   - После этого исправить аннотации типов
   - В конце обновить документацию

Изменения Итерации 1 являются **низкорисковыми** и могут быть выполнены без серьезного воздействия на остальной код.