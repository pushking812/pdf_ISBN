# План модификации проверки полноты данных ISBN

## Цель
Обеспечить поиск данных для ISBN, у которых в кэше присутствуют заглушки (неполные данные), даже при отсутствии флага `--rescan`.

## Текущая ситуация
Функция `is_book_data_complete` в `main.py` проверяет только наличие непустых title, authors и year. Значения-заглушки, такие как:
- Title: `"Не удалось определить название"`, `"Нет названия"`
- Authors: `["Неизвестный автор"]`
- Year: `"не указан"`
- Pages: `"не указано"`, `"0"`

считаются валидными, что приводит к пропуску поиска для таких ISBN.

## Предлагаемые изменения

### 1. Модификация `is_book_data_complete`
Заменить функцию на новую, которая учитывает заглушки.

```python
def is_book_data_complete(record: Optional[Dict[str, Any]]) -> bool:
    """
    Считаем запись полной, если есть непустое название, авторы и год,
    и ни одно из этих полей не содержит значений-заглушек.
    Дополнительно проверяем pages, если поле присутствует.
    """
    if not record:
        return False

    title = record.get("title")
    authors = record.get("authors")
    year = record.get("year")
    pages = record.get("pages")

    # Заглушки для каждого поля
    TITLE_STUBS = {"не удалось определить название", "нет названия"}
    AUTHOR_STUBS = {"неизвестный автор"}
    YEAR_STUBS = {"не указан"}
    PAGES_STUBS = {"не указано", "0"}

    # Проверка title
    if not title or not isinstance(title, str):
        return False
    title_lower = title.strip().lower()
    if title_lower in TITLE_STUBS:
        return False

    # Проверка authors
    if not authors or not isinstance(authors, list) or len(authors) == 0:
        return False
    # Проверяем, что хотя бы один автор не является заглушкой
    all_authors_stub = all(
        isinstance(a, str) and a.strip().lower() in AUTHOR_STUBS
        for a in authors
    )
    if all_authors_stub:
        return False

    # Проверка year
    if not year:
        return False
    year_str = str(year).strip().lower()
    if year_str in YEAR_STUBS:
        return False
    # Дополнительно можно проверить, что year содержит хотя бы одну цифру
    if not any(ch.isdigit() for ch in year_str):
        return False

    # Проверка pages (опционально)
    if pages is not None:
        pages_str = str(pages).strip().lower()
        if pages_str in PAGES_STUBS:
            return False

    return True
```

### 2. Дополнительные улучшения (опционально)
- Добавить конфигурируемый список заглушек через config.json.
- Внести изменения в скраперы и API-клиенты, чтобы они не возвращали заглушки, а возвращали `None` для отсутствующих полей (но это может нарушить существующие форматы).

### 3. Тестирование
- Написать unit-тесты для новой функции, используя pytest.
- Провести интеграционный тест: запустить скрипт с существующим кэшем (isbn_data_cache.json) и убедиться, что для записей с заглушками выполняется поиск.

### 4. Проверка влияния
- Убедиться, что изменения не нарушают работу существующего функционала (флаг `--rescan` по-прежнему работает).
- Проверить, что после поиска данные обновляются в кэше (если найдены более полные данные).

## Порядок реализации
1. Создать backup кэша.
2. Внести изменения в `main.py`.
3. Запустить тесты (если есть).
4. Выполнить пробный запуск скрипта на небольшом наборе PDF.
5. Убедиться, что для ISBN с заглушками происходит поиск.
6. При необходимости скорректировать логику.

## Риски
- Изменение критериев полноты может привести к излишним запросам для ISBN, у которых данные действительно отсутствуют (например, книга не найдена ни на одном ресурсе). Это допустимо, так как поиск будет выполнен и вернёт те же заглушки, которые затем не попадут в кэш (из-за фильтрации).
- Возможно увеличение времени выполнения из-за дополнительных запросов.

## Альтернативы
- Ввести отдельный флаг `--force-update-incomplete` для принудительного поиска неполных данных, но пользователь хочет автоматическое поведение без флагов.

## Примечание
После реализации необходимо обновить документацию (если есть) и уведомить пользователя об изменении поведения.