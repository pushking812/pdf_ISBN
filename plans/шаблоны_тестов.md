# Шаблоны тестов для ресурсов

## 1. conftest.py

```python
import pytest
import aiohttp
import asyncio
from pathlib import Path

def load_isbn_list():
    """Загружает список ISBN из файла isbn_list.txt."""
    path = Path(__file__).parent.parent / "isbn_list.txt"
    with open(path, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    isbns = [line.strip() for line in lines if line.strip()]
    return isbns

@pytest.fixture(scope="session")
def isbn_list():
    return load_isbn_list()

@pytest.fixture(scope="session")
async def aiohttp_session():
    """Сессия aiohttp для асинхронных тестов."""
    session = aiohttp.ClientSession()
    yield session
    await session.close()

@pytest.fixture(scope="session")
def scraper_config():
    """Конфигурация скрапера по умолчанию."""
    from config import ScraperConfig
    return ScraperConfig(headless=True, skip_main_page=True)
```

## 2. test_api_clients_sync.py

```python
import pytest
from api_clients import (
    get_from_google_books,
    get_from_open_library,
    get_from_rsl
)

SYNC_CLIENTS = [
    ("Google Books", get_from_google_books),
    ("Open Library", get_from_open_library),
    ("РГБ", get_from_rsl),
]

@pytest.mark.parametrize("resource_name, client_func", SYNC_CLIENTS)
def test_sync_client_returns_data_for_at_least_one_isbn(resource_name, client_func, isbn_list):
    """
    Тест, что синхронный клиент возвращает данные хотя бы для одного ISBN.
    """
    success = False
    errors = []
    
    for isbn in isbn_list[:10]:  # Ограничимся первыми 10 ISBN для скорости
        try:
            result = client_func(isbn)
            if result is not None:
                # Проверяем, что есть хотя бы заголовок
                assert "title" in result
                assert result["title"] not in ("Нет названия", "")
                success = True
                print(f"{resource_name}: успех для ISBN {isbn}")
                break
        except Exception as e:
            errors.append(f"{isbn}: {e}")
            continue
    
    if not success:
        pytest.skip(f"{resource_name}: ни один ISBN не вернул данные. Ошибки: {errors}")
```

## 3. test_api_clients_async.py

```python
import pytest
import asyncio
from api_clients import (
    get_from_google_books_async,
    get_from_open_library_async,
    get_from_rsl_async
)

ASYNC_CLIENTS = [
    ("Google Books async", get_from_google_books_async),
    ("Open Library async", get_from_open_library_async),
    ("РГБ async", get_from_rsl_async),
]

@pytest.mark.asyncio
@pytest.mark.parametrize("resource_name, client_func", ASYNC_CLIENTS)
async def test_async_client_returns_data_for_at_least_one_isbn(
    resource_name, client_func, isbn_list, aiohttp_session
):
    """
    Тест, что асинхронный клиент возвращает данные хотя бы для одного ISBN.
    """
    success = False
    errors = []
    
    for isbn in isbn_list[:10]:
        try:
            result = await client_func(aiohttp_session, isbn)
            if result is not None:
                assert "title" in result
                assert result["title"] not in ("Нет названия", "")
                success = True
                print(f"{resource_name}: успех для ISBN {isbn}")
                break
        except Exception as e:
            errors.append(f"{isbn}: {e}")
            continue
    
    if not success:
        pytest.skip(f"{resource_name}: ни один ISBN не вернул данные. Ошибки: {errors}")
```

## 4. test_scrapers.py

```python
import pytest
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from drivers import create_chrome_driver
from resources import get_scraper_resources
from scraper import parse_book_page_for_resource

@pytest.fixture(scope="module")
def driver(scraper_config):
    """Фикстура драйвера для скраперов."""
    driver = create_chrome_driver(headless=scraper_config.headless)
    yield driver
    driver.quit()

def test_scraper_chitai_gorod(driver, isbn_list, scraper_config):
    """Тест скрапера Читай-город."""
    resources = get_scraper_resources(scraper_config)
    resource = next(r for r in resources if r["id"] == "chitai-gorod")
    
    success = False
    for isbn in isbn_list[:5]:  # Проверяем первые 5 ISBN
        try:
            search_url = resource["search_url_template"].format(isbn=isbn)
            driver.get(search_url)
            
            # Ожидание загрузки страницы
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "body"))
            )
            
            # Проверка на отсутствие товара
            page_text = driver.page_source
            if any(phrase in page_text for phrase in resource.get("no_product_phrases", [])):
                continue
            
            # Поиск ссылки на товар
            product_link = None
            for selector in resource["product_link_selectors"]:
                links = driver.find_elements(By.CSS_SELECTOR, selector)
                if links:
                    product_link = links[0]
                    break
            
            if not product_link:
                continue
            
            # Клик по товару
            product_link.click()
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "body"))
            )
            
            # Парсинг страницы
            data = parse_book_page_for_resource(driver, resource)
            if data and data.get("title") and data.get("authors"):
                success = True
                print(f"Читай-город: успех для ISBN {isbn}")
                break
        except Exception as e:
            print(f"Ошибка для ISBN {isbn}: {e}")
            continue
    
    if not success:
        pytest.skip("Читай-город: ни один ISBN не дал результата")

def test_scraper_book_ru(driver, isbn_list, scraper_config):
    """Тест скрапера Book.ru."""
    resources = get_scraper_resources(scraper_config)
    resource = next(r for r in resources if r["id"] == "book-ru")
    
    success = False
    for isbn in isbn_list[:5]:
        try:
            search_url = resource["search_url_template"].format(isbn=isbn)
            driver.get(search_url)
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "body"))
            )
            
            page_text = driver.page_source
            if any(phrase in page_text for phrase in resource.get("no_product_phrases", [])):
                continue
            
            product_link = None
            for selector in resource["product_link_selectors"]:
                links = driver.find_elements(By.CSS_SELECTOR, selector)
                if links:
                    product_link = links[0]
                    break
            
            if not product_link:
                continue
            
            product_link.click()
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "body"))
            )
            
            data = parse_book_page_for_resource(driver, resource)
            if data and data.get("title") and data.get("authors"):
                success = True
                print(f"Book.ru: успех для ISBN {isbn}")
                break
        except Exception as e:
            print(f"Ошибка для ISBN {isbn}: {e}")
            continue
    
    if not success:
        pytest.skip("Book.ru: ни один ISBN не дал результата")
```

## 5. utils.py (опционально)

```python
import time
from typing import Callable, Any

def retry_on_failure(func: Callable, max_attempts: int = 3, delay: float = 1.0) -> Any:
    """Повторяет вызов функции при возникновении исключений."""
    for attempt in range(max_attempts):
        try:
            return func()
        except Exception as e:
            if attempt == max_attempts - 1:
                raise
            time.sleep(delay)
```

## 6. Запуск тестов

```bash
# Установить зависимости
pip install pytest pytest-asyncio aiohttp requests beautifulsoup4 selenium

# Запустить все тесты
pytest tests/ -v

# Запустить только синхронные тесты
pytest tests/test_api_clients_sync.py -v

# Запустить только асинхронные тесты
pytest tests/test_api_clients_async.py -v

# Запустить только тесты скраперов
pytest tests/test_scrapers.py -v